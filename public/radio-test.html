<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Radio Audio Test</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
      max-width: 600px;
      width: 100%;
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .subtitle {
      color: #999;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .control-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    label {
      display: block;
      color: #555;
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 14px;
    }
    select, input {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      flex: 1;
      min-width: 100px;
    }
    button {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-top: 25px;
    }
    button:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
    button:active { transform: translateY(0); }
    .output {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 20px;
      margin-top: 30px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      display: none;
    }
    .output.active { display: block; }
    .log-entry {
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 4px;
      line-height: 1.4;
    }
    .log-entry.success { background: #d4edda; color: #155724; border-left: 3px solid #28a745; }
    .log-entry.error { background: #f8d7da; color: #721c24; border-left: 3px solid #dc3545; }
    .log-entry.info { background: #d1ecf1; color: #0c5460; border-left: 3px solid #17a2b8; }
    .log-entry.warning { background: #fff3cd; color: #856404; border-left: 3px solid #ffc107; }
    audio {
      width: 100%;
      margin-top: 20px;
      background: #f0f0f0;
    }
    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 6px;
      display: none;
      font-weight: 600;
    }
    .status.active { display: block; }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.info { background: #d1ecf1; color: #0c5460; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸŽµ Radio Audio Test</h1>
    <p class="subtitle">Test the Quran.com radio audio streaming</p>

    <div class="control-group">
      <div style="flex: 1;">
        <label>Reciter ID</label>
        <select id="reciterId">
          <option value="1">1 - AbdulBaset AbdulSamad (Mujawwad)</option>
          <option value="2">2 - AbdulBaset AbdulSamad (Murattal)</option>
          <option value="3">3 - Abdur-Rahman as-Sudais</option>
          <option value="7">7 - Mishari Rashid al-Afasy</option>
        </select>
      </div>
    </div>

    <div class="control-group">
      <div style="flex: 1;">
        <label>Surah Number</label>
        <input type="number" id="surahNumber" min="1" max="114" value="1">
      </div>
    </div>

    <button onclick="testAudio()">Load Audio</button>

    <div class="status" id="status"></div>
    <div class="output" id="output"></div>
    <audio id="player" controls></audio>
  </div>

  <script>
    let logs = [];

    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const entry = `[${timestamp}] ${message}`;
      logs.push({ message: entry, type });
      renderLogs();
      console.log(`[${type.toUpperCase()}]`, message);
    }

    function renderLogs() {
      const output = document.getElementById('output');
      const outputDiv = output.innerHTML = '';
      logs.forEach(log => {
        const div = document.createElement('div');
        div.className = `log-entry ${log.type}`;
        div.textContent = log.message;
        output.appendChild(div);
      });
      output.classList.add('active');
      output.scrollTop = output.scrollHeight;
    }

    function showStatus(message, type = 'info') {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status active ${type}`;
    }

    async function testAudio() {
      logs = [];
      const reciterId = document.getElementById('reciterId').value;
      const surahNumber = document.getElementById('surahNumber').value;

      addLog(`Starting audio test for Surah ${surahNumber}, Reciter ${reciterId}`, 'info');
      showStatus('Loading...', 'info');

      try {
        // Step 1: Fetch audio URLs
        addLog(`Fetching audio data from /api/radio/audio`, 'info');
        const audioUrl = `/api/radio/audio?reciterId=${reciterId}&surahNumber=${surahNumber}`;
        addLog(`URL: ${audioUrl}`, 'info');

        const audioResponse = await fetch(audioUrl, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!audioResponse.ok) {
          throw new Error(`Audio endpoint returned ${audioResponse.status}: ${audioResponse.statusText}`);
        }

        const audioData = await audioResponse.json();
        addLog(`âœ“ Audio endpoint response received`, 'success');
        addLog(`Surah: ${audioData.data.surahName}`, 'success');
        addLog(`Total Verses: ${audioData.data.totalVerses}`, 'success');

        if (!audioData.data.audioUrls || audioData.data.audioUrls.length === 0) {
          throw new Error('No audio URLs returned from endpoint');
        }

        const firstUrl = audioData.data.audioUrls[0];
        addLog(`First Audio URL: ${firstUrl}`, 'info');

        // Step 2: Test the audio stream endpoint
        addLog(`Testing audio stream endpoint...`, 'info');
        const streamResponse = await fetch(firstUrl, {
          method: 'GET',
          headers: { 'Accept': 'audio/mpeg, audio/*, */*' }
        });

        if (!streamResponse.ok) {
          throw new Error(`Stream endpoint returned ${streamResponse.status}: ${streamResponse.statusText}`);
        }

        const contentType = streamResponse.headers.get('content-type');
        const contentLength = streamResponse.headers.get('content-length');
        addLog(`âœ“ Audio stream endpoint working`, 'success');
        addLog(`Content-Type: ${contentType}`, 'success');
        addLog(`Content-Length: ${contentLength} bytes`, 'success');

        // Step 3: Get audio blob
        const audioBlob = await streamResponse.blob();
        addLog(`âœ“ Audio blob received: ${audioBlob.size} bytes`, 'success');

        if (audioBlob.size === 0) {
          throw new Error('Audio blob is empty');
        }

        // Step 4: Play the audio
        const blobUrl = URL.createObjectURL(audioBlob);
        const player = document.getElementById('player');
        player.src = blobUrl;
        addLog(`âœ“ Audio loaded in player`, 'success');
        addLog(`Ready to play!`, 'success');

        showStatus('âœ“ Audio loaded successfully! Click play to listen.', 'success');

      } catch (error) {
        addLog(`âœ— Error: ${error.message}`, 'error');
        showStatus(`âœ— Error: ${error.message}`, 'error');
      }
    }

    // Log page load
    addLog('Page loaded - Ready to test audio', 'success');
  </script>
</body>
</html>
